// âœ… POST /todos - Add new todo
app.post("/todos", authMiddleware, async (req, res) => {
  try {
    // Trim title and check if it's empty
    const trimmedTitle = req.body.title?.trim();
    if (!trimmedTitle) return res.status(400).json({ message: "Title required" });

    // Check for duplicate title for the same user
    const existing = await Todo.findOne({ title: trimmedTitle, user: req.userId });
    if (existing) return res.status(400).json({ message: "Task already exists" });

    // Create new todo
    const todo = new Todo({
      title: trimmedTitle,
      completed: false,
      user: req.userId,
    });

    await todo.save();
    res.status(201).json(todo);

  } catch (err) {
    // Handle duplicate key error from MongoDB just in case
    if (err.code === 11000) {
      return res.status(400).json({ message: "Task already exists" });
    }

    console.error("Add Todo Error:", err);
    res.status(500).json({ message: "Server error", error: err.message });
  }
});
